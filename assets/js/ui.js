$(document).ready(function() {
  $(".dashboard-sidebar .sidebar-button").click(function() {
    $("body").scrollTop(0);
    reset_dashboard();
    initMap(0,0);
    $(this).addClass("active");
    $(this).siblings().removeClass("active");
    $(".mob-menu .sidebar-button").removeClass("active");
    $(".mob-menu .sidebar-button[data-lineid='" + $(this).attr("data-lineid") + "']").addClass('active');
    $(".dashboard-content").find(".placeholder-icon").fadeOut(0);
    $(".dashboard-content").find(".placeholder-icon").addClass("placeholder-icon-" + $(this).attr("data-lineid"));
    $(".dashboard-content").find(".placeholder-icon").fadeIn("slow");
    $("#stops").empty();
    fetchTFLdata($(this).attr("data-lineid"));
  });

  $(".mob-menu .sidebar-button").click(function() {
    $("body").scrollTop(0);
    reset_dashboard();
    initMap(0,0);
    $(".mob-menu .sidebar-button").removeClass("active");
    $(this).addClass("active");
    $(".navbar-toggler").click();
    $(".dashboard-sidebar").children(".sidebar-button").removeClass("active");
    $(".dashboard-sidebar").children(".sidebar-button[data-lineid='" + $(this).attr("data-lineid") + "']").addClass('active');
    $(".dashboard-content").find(".placeholder-icon").addClass("placeholder-icon-" + $(this).attr("data-lineid"));
    $("#stops").empty();
    fetchTFLdata($(this).attr("data-lineid"));
  });

  var num_lines = $(".dashboard-sidebar .sidebar-button").length;
  var div_width = (1/num_lines) * 100;

  for (i = 0; i < num_lines; i++) {
    $("footer").prepend(`<div class="footer-tops f` + i + `" style="width:` + div_width + `%"></div>`);
  }

  var min_content_height = $(window).height() - $("header").outerHeight() - $("footer").outerHeight();
  $("main").css("min-height",min_content_height+"px");

  // Graphs generated by d3/dc are not responsive - this helps remedy that
  // by resizing SVGs to their parent div width
  function resize_svg() {
    if ($("#station_dropdown option:selected").val() != "0" && $("#loading").is(':empty')) {
      $(".chart").each(function() {
          var graph_width = $(this).outerWidth() - 20;
          $(this).children("div:first").width(graph_width);
          $(this).children("div:first svg").width(graph_width);
      });
      reset_titles();
      dc.renderAll();
      load_titles_styles();
    }
  }

  $(window).resize(function() {
    resize_svg();
    var min_content_height = $(window).height() - $("header").outerHeight() - $("footer").outerHeight();
    $("main").css("min-height",min_content_height+"px");
  });

  fetchTFLdata("bakerloo");
});

function clear_divs() {
  $("#loading").empty();
  $("#crime-selector").empty();
  $("#force-selector").empty();
  $("#pie-chart").empty();
  $("#line-chart").empty();
  $("#map").empty();
}

function reset_dashboard() {
  clear_divs();
  $("#pie-chart").html(`<i class="fas fa-chart-pie placeholder-icon"></i>`);
  $("#line-chart").html(`<i class="fas fa-chart-area placeholder-icon"></i>`);
  $("#map").html(`<i class="fas fa-map-marker-alt placeholder-icon"></i>`);
}

function refresh_dashboard_content() {
  if ($("#station_dropdown").val() != "0") {
    $("body").scrollTop(0);
    // Determine coordinates of the tube station
    lat = parseFloat($("#station_dropdown").find('option:selected').attr("lat"));
    lon = parseFloat($("#station_dropdown").find('option:selected').attr("lon"));
    // Clear graphs
    clear_divs();
    $("#loading").html(`<img src="assets/images/loading.gif" width="100" />`);
    // Render Map
    initMap(lat, lon);
    // Get Street Crime data and render graphs, referencing tube line colour for the line chart
    col = $(".dashboard-sidebar .sidebar-button.active").css("background-color");
    var street_crimes = fetchStreetCrimeData(lat, lon, col);
  }
}
